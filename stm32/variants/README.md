# KLST / variants

- KLST_SHEEP (STM32H743VI)
- KLST_CORE (STM32H743II)
- KLST_TINY (STM32F446RE)

## KLST functions

- application-level functions are located in the `klangstrom` namespace
- *internal shared* (ISH) functions are prefixed with `KLST_ISH_`
- *board-specific* (BSP) functions are prefixed with `KLST_BSP_`

see `KlangstromApplicationArduinoInterface.h` for all functions

## variant file structure

each variant folder contains the following files adapted to the respective architecture ( *STM32CubeIDE* auto-generated files from #STM32CubeIDE or copied files from #STM32duino ):

- `ldscript.ld` :: linker script generated by #STM32CubeIDE copied from file `*_FLASH.ld`
- `PeripheralPins_KLST_*.c` :: board specific pin configuration copied from generic variante #STM32duino
- `PinNamesVar.h` :: copied from generic variante #STM32duino
- `variant_KLST_*-BSP.h` + `variant_KLST_*-BSP.c` :: functions generated by #STM32CubeIDE
- `variant_KLST_*.h` + `variant_KLST_*.cpp` :: #STM32duino

also make sure to check the following:

- add call to `PeriphCommonClock_Config()` at the end of `SystemClock_Config()`
- check `stm32**xx_hal_conf.h` if any configurations need to be copied over to `variant_KLST_*.h` ( e.g `HSE_VALUE` or `HAL_XXX_MODULE_ENABLED` )
- USB clock initialization does not always happen in `PeriphCommonClock_Config()`. to manually intialize the USB clock the following lines must be added to `PeriphCommonClock_Config()`. e.g:
    - for *KLST_TINY* add `| RCC_PERIPHCLK_CLK48` to  `PeriphClkInitStruct.PeriphClockSelection` and add line `PeriphClkInitStruct.Clk48ClockSelection = RCC_CLK48CLKSOURCE_PLLSAIP;`
    - for *KLST_SHEEP* add `| RCC_PERIPHCLK_USB` to `PeriphClkInitStruct.PeriphClockSelection` and add line `PeriphClkInitStruct.UsbClockSelection = RCC_USBCLKSOURCE_HSI48;`

the following files comprise the KLST variant *KLST_SHEEP*:

### `variant_KLST_SHEEP-BSP.h` + `variant_KLST_SHEEP-BSP.c` 

the following files were generated by STM32CubeIDE:

- `main.h`
- `main.c`
- `stm32h7xx_hal_msp.c`
- `stm32h7xx_it.h`
- `stm32h7xx_it.c`
- `usbd_conf.c` and `usbh_conf.c`

the below functions were extracted from the files above and added to `variant_KLST_SHEEP-BSP.c`:

#### `main.h`

- `/* Private definess ---...`

#### `main.c`

- `/* Private variables ---...`
- `/* Private function prototypes ---...`
- `void SystemClock_Config(void)` ( make sure `PeriphCommonClock_Config();` is called at the end of this function )
- `void PeriphCommonClock_Config(void)`
- `void MX_GPIO_Init(void)`
- `void MX_DMA_Init(void)`
- `void MX_I2C1_Init(void)`
- `void MX_SAI1_Init(void)`
- `void MX_SPI3_Init(void)`
- `void MX_TIM1_Init(void)`
- `void MX_TIM2_Init(void)`

#### `stm32h7xx_it.c`

- `void DMA1_Stream0_IRQHandler(void)`
- `void DMA1_Stream1_IRQHandler(void)`
- `void SPI3_IRQHandler(void)`
- `void DMA2_Stream0_IRQHandler(void)`

#### `stm32h7xx_hal_msp.c`

- `void HAL_MspInit(void)`
- `void HAL_I2C_MspInit(I2C_HandleTypeDef* hi2c)`
- `void HAL_I2C_MspDeInit(I2C_HandleTypeDef* hi2c)`
- `void HAL_SPI_MspInit(SPI_HandleTypeDef* hspi)`
- `void HAL_SPI_MspDeInit(SPI_HandleTypeDef* hspi)`
- `void HAL_TIM_Encoder_MspInit(TIM_HandleTypeDef* htim_encoder)`
- `void HAL_TIM_Encoder_MspDeInit(TIM_HandleTypeDef* htim_encoder)`
- `void HAL_SAI_MspInit(SAI_HandleTypeDef* hsai)`
- `void HAL_SAI_MspDeInit(SAI_HandleTypeDef* hsai)`

#### `usbd_conf.h` or `usbh_conf.c`

note that peripheral clock configuration for USB must be added to `void PeriphCommonClock_Config(void)` from `HAL_PCD_MspInit(void)` or `HAL_HCD_MspInit(void)`

### `variant_KLST_*.h`

- specifiy `PIN MAP`, `HAL` + `PERIPHERALS` sections
- check definitions in `stm32**xx_hal_conf.h` ( e.g `HSE_VALUE` or enabled modules ( e.g `HAL_SAI_MODULE_ENABLED` for `KLST_TINY` ) ) and if needed copy to `variant_KLST_****.h`.
- define board type ( e.g `#define KLST_BOARD_KLST_TINY` )
- define peripherals:
    - `LED_BUILTIN`
    - `USER_BTN`
    - `PIN_SPI_MOSI` +  `PIN_SPI_MISO` +  `PIN_SPI_SCK` +  `PIN_SPI_SS` ( `CS` )
    - `PIN_WIRE_SDA` + `PIN_WIRE_SCL` ( `I2C` )
    - `TIMER_TONE`
    - `TIMER_SERVO`
    - `PIN_SERIAL_RX` + `PIN_SERIAL_TX`
- define `KLST_UART_BAUD` + `KLST_SERIAL_**`
- remove default/onboard defines

## BSP implementation in Klangstrom library folder

the *Klangstrom* library folder also contains BSP implementations:

- `‌KlangstromApplication_KLST_*-BSP.cpp` implements functions specified in `‌KlangstromApplicationArduinoInterface.h ` ( prefixed with `KLST_BSP_` )
